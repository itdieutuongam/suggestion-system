<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ĐỀ XUẤT / ĐỀ NGHỊ - DTA SPACE</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #a41017; padding-bottom: 15px; margin-bottom: 25px; }
        .header h1 { margin: 0; color: #a41017; font-size: 26px; }
        .header small { font-size: 16px; color: #555; }
        .user-info { text-align: right; font-size: 15px; }
        .logout { color: #d32f2f; font-weight: bold; text-decoration: none; }

        .alert { padding: 14px 18px; margin: 15px 0; border-radius: 8px; border-left: 6px solid; font-weight: 500; }
        .alert-success { background:#d4edda; border-left-color:#28a745; color:#155724; }
        .alert-danger  { background:#f8d7da; border-left-color:#dc3545; color:#721c24; }
        .alert-warning { background:#fff3cd; border-left-color:#ffc107; color:#856404; }
        .alert-info    { background:#d1ecf1; border-left-color:#a41017; color:#0c5460; }

        label { display: block; margin: 18px 0 6px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        textarea { min-height: 130px; resize: vertical; }
        input:disabled { background: #f8f9fa; color: #555; }

        table { width: 100%; border-collapse: collapse; margin: 25px 0; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #a41017; color: white; font-weight: bold; }
        
        /* QUAN TRỌNG: Style cho input trong table */
        td input[type="text"],
        td input[type="number"] { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
            font-size: 14px;
        }
        
        td.thanhTien {
            font-weight: bold;
            color: #a41017;
            font-size: 15px;
        }
        
        .btn { padding: 10px 18px; margin: 8px 5px 0 0; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #a41017; color: white; font-weight: bold; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; padding: 6px 10px; font-size: 13px; }

        .grand-total { font-size: 1.5em; font-weight: bold; color: #a41017; text-align: right; margin: 25px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; }
        
        .file-upload { margin: 20px 0; padding: 15px; border: 2px dashed #a41017; border-radius: 8px; text-align: center; background: #f8fbff; }
        .file-upload input[type="file"] { margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>HỆ THỐNG ĐỀ XUẤT / ĐỀ NGHỊ<br><small>CÔNG TY CỔ PHẦN DTA SPACE</small></h1>
        <div class="user-info">
            Xin chào <strong>{{ user.name }}</strong> ({{ user.role }})<br>
            <a href="{{ url_for('dashboard') }}">Trang chủ</a> |
            <a href="{{ url_for('logout') }}" class="logout">Đăng xuất</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">
        <label>Ngày lập:</label>
        <input type="text" value="{{ today }}" disabled>

        <label>Người lập:</label>
        <input type="text" value="{{ user.name }}" disabled>

        <label>Phòng ban:</label>
        <select name="department" required>
            <option value="">-- Chọn phòng ban --</option>
            {% for dept in departments %}
            <option value="{{ dept }}" {% if dept == user.department %}selected{% endif %}>{{ dept }}</option>
            {% endfor %}
        </select>

        <label>Thành phố áp dụng <span style="color:red;">*</span>:</label>
        <select name="city" required>
            <option value="" disabled selected>-- Chọn thành phố --</option>
            <option value="HÀ NỘI">HÀ NỘI</option>
            <option value="HỒ CHÍ MINH">HỒ CHÍ MINH</option>
        </select>
            
        <label>Tiêu đề đề nghị:</label>
        <input type="text" name="title" placeholder="Ví dụ: Đề xuất thanh toán chi phí văn phòng tháng 12" required>

        <label>Phương thức thanh toán <span style="color:red;">*</span>:</label>
        <select name="type" required>
            <option value="" disabled selected>-- Chọn phương thức --</option>
            <option value="Tiền mặt">Tiền mặt</option>
            <option value="Chuyển khoản">Chuyển khoản</option>
        </select>

        <label>Nội dung chi tiết:</label>
        <textarea name="content" placeholder="Mô tả rõ lý do, mục đích, lợi ích, kế hoạch thực hiện, thời gian..." required></textarea>

        <label>Người phê duyệt tiếp theo:</label>
        <select name="approver" required>
            <option value="" disabled selected>-- Chọn người duyệt --</option>
            {% for approver in approvers %}
            <option value="{{ approver }}">{{ approver }}</option>
            {% endfor %}
        </select>

        <h3 style="margin-top: 30px; color: #a41017;">Chi phí đề nghị (nếu có)</h3>
        <table id="costTable">
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="35%">Hạng mục</th>
                    <th width="15%">Lần 1</th>
                    <th width="15%">Lần 2</th>
                    <th width="20%">Thành tiền</th>
                    <th width="10%">Xóa</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="stt">1</td>
                    <td><input type="text" class="item" placeholder="Nhập hạng mục"></td>
                    <td><input type="number" class="lan1" value="0" min="0"></td>
                    <td><input type="number" class="lan2" value="0" min="0"></td>
                    <td class="thanhTien">0</td>
                    <td><button type="button" class="btn btn-danger remove">X</button></td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="addRow" class="btn btn-secondary">+ Thêm dòng chi phí</button>

        <div class="grand-total">
            Tổng cộng: <span id="grandTotal">0</span> VND
            <input type="hidden" name="total_cost" id="totalCostInput" value="0">
        </div>

        <div class="file-upload">
            <h3>Đính kèm tệp (nếu có)</h3>
            <p>Hỗ trợ: PDF, Word, Excel, hình ảnh (tối đa 16MB)</p>
            <input type="file" name="attachment" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
        </div>

        <div style="text-align: center; margin: 40px 0;">
            <button type="submit" class="btn btn-primary" style="padding: 14px 40px; font-size: 17px;">
                Gửi & Chuyển duyệt
            </button>
            <button type="reset" class="btn btn-secondary" style="padding: 14px 30px; font-size: 16px;">
                Làm mới form
            </button>
        </div>
    </form>
</div>

<script>
function formatVND(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function updateAll() {
    let total = 0;
    $("#costTable tbody tr").each(function(i) {
        $(this).find(".stt").text(i + 1);
        let lan1 = parseInt($(this).find(".lan1").val()) || 0;
        let lan2 = parseInt($(this).find(".lan2").val()) || 0;
        let sum = lan1 + lan2;
        $(this).find(".thanhTien").text(formatVND(sum));
        total += sum;
    });
    $("#grandTotal").text(formatVND(total));
    $("#totalCostInput").val(total);
}

$("#addRow").on("click", function() {
    let newRow = $("#costTable tbody tr:last").clone();
    newRow.find(".item").val("");
    newRow.find(".lan1, .lan2").val("0");
    newRow.find(".thanhTien").text("0");
    newRow.find(".stt").text("");
    $("#costTable tbody").append(newRow);
    updateAll();
});

$(document).on("click", ".remove", function() {
    if ($("#costTable tbody tr").length <= 1) {
        alert("Phải giữ lại ít nhất 1 dòng chi phí!");
        return;
    }
    $(this).closest("tr").remove();
    updateAll();
});

$(document).on("input", ".lan1, .lan2", updateAll);
$(document).ready(updateAll);
</script>
</body>
</htm